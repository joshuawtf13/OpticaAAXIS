<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel de Administración - Óptica ITP</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .admin-container {
      max-width: 960px;
      margin: auto;
      padding: 20px;
    }
    .formulario, .promo-list {
      background: #fff;
      margin-top: 20px;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .preview-image, .editar-img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 8px;
    }
    .promo-item {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }
    .promo-info {
      flex: 1;
    }
    .promo-info input, .promo-info select, .promo-info textarea {
      width: 100%;
      margin: 5px 0;
      padding: 6px;
    }
    button {
      margin: 4px 4px 0 0;
      padding: 6px 12px;
      background: #87CEEB;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background: #4682B4;
    }
    .alerta {
  background-color: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
  padding: 10px 20px;
  border-radius: 5px;
  margin: 10px auto;
  font-weight: bold;
  display: none;
  text-align: center;
  width: fit-content;
  max-width: 90%;
  animation: fadeInOut 3s ease-in-out;
  z-index: 9999;
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

@keyframes fadeInOut {
  0% { opacity: 0; }
  10% { opacity: 1; }
  90% { opacity: 1; }
  100% { opacity: 0; }
}

.input-file-wrapper {
  position: relative;
  display: inline-block;
}

.input-file-wrapper input[type="file"] {
  opacity: 0;
  position: absolute;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  cursor: pointer;
}

.input-file-button {
  background: #f0f0f0;
  border: 1px solid #ccc;
  padding: 4px 10px;
  border-radius: 5px;
  font-size: 12px;
  cursor: pointer;
  display: inline-block;
}


  </style>
</head>
<body>
  
  <header>
    <h1>Panel de Administración</h1>
    <nav><a href="index.html">Regresar a Página Principal</a></nav>
  </header>

  <main>
    
    <section class="admin-container">
      

      <h2>Gestión de Contenido</h2>
	      <!-- SUBIR PRODUCTO -->
      <div class="formulario">
        <h3>Subir Producto</h3>
        <input type="file" id="fileProducto" accept="image/*" onchange="subirACloudinaryProducto(this)">
<img id="previewProducto" class="preview-image" style="display:none;">
<input type="hidden" id="urlImagenProducto">

        <input type="text" id="descripcionProducto" placeholder="Descripción">
        <input type="number" id="precioProducto" placeholder="Precio">
        <select id="categoriaProducto">
          <option value="caballero">Caballero</option>
          <option value="dama">Dama</option>
          <option value="niños">Niños</option>
          <option value="niñas">Niñas</option>
          <option value="accesorios">Accesorios</option>
        </select>
        <button onclick="subirProducto()">Guardar Producto</button>
<button onclick="limpiarFormularioProducto()">Limpiar</button>

      </div>

      <!-- SUBIR PROMOCION -->
      <!-- SUBIR PROMOCIÓN -->
<div class="formulario">
  <h3>Subir Promoción</h3>
  <input type="file" id="filePromocion" accept="image/*" onchange="subirACloudinaryPromocion(this)">
<img id="previewPromocion" class="preview-image" style="display:none;">
<input type="hidden" id="urlImagenPromocion">

  <textarea id="descripcionPromocion" placeholder="Descripción de la promoción"></textarea>

  <label><strong>Categorías (opcional)</strong></label>
  <div id="categoriasCheckboxes" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;"></div>

  <label><strong>Productos relacionados (opcional)</strong></label>
  <div id="productosCheckboxes" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;"></div>

  <label>Fecha de vencimiento</label>
  <input type="date" id="vencimientoPromocion">
  <button onclick="subirPromocion()">Guardar Promoción</button>
<button onclick="limpiarFormularioPromocion()">Limpiar</button>


</div>

      <!-- PRODUCTOS REGISTRADOS -->
      <div class="formulario promo-list">
        <h3>Productos registrados</h3>
        <div id="listaProductos"></div>
      </div>

      <!-- PROMOCIONES REGISTRADAS -->
      <div class="formulario promo-list">
        <h3>Promociones registradas</h3>
        <div id="listaPromociones"></div>
      </div>
    </section>
  </main>
  <div id="alerta" class="alerta"></div>  
<script>
  let tempProductos = {};
  let tempPromos = [];

  function previsualizarImagen(event, id) {
    const reader = new FileReader();
    reader.onload = () => document.getElementById(id).src = reader.result;
    reader.readAsDataURL(event.target.files[0]);
  }
function crearCheckboxesCategorias() {
  const contenedor = document.getElementById("categoriasCheckboxes");
  const categorias = ["caballero", "dama", "niños", "niñas", "accesorios"];
  contenedor.innerHTML = "";
  categorias.forEach(cat => {
    contenedor.innerHTML += `
      <label>
        <input type="checkbox" name="categoriaPromo" value="${cat}"> ${cat.charAt(0).toUpperCase() + cat.slice(1)}
      </label>
    `;
  });
}

function crearCheckboxesProductos() {
  const contenedor = document.getElementById("productosCheckboxes");
  contenedor.innerHTML = "";
  const categorias = ["caballero", "dama", "niños", "niñas", "accesorios"];

  categorias.forEach(cat => {
    const productos = JSON.parse(localStorage.getItem(cat)) || [];
    if (productos.length === 0) return;

    const productosHTML = productos.map(p => `
      <label style="display: flex; flex-direction: column; align-items: center; width: 100px;">
        <input type="checkbox" name="productoPromo" value='${JSON.stringify({ descripcion: p.descripcion, categoria: cat })}'>
        <img src="${p.imagen}" alt="preview" style="width:60px; height:60px; object-fit:cover; border-radius:6px;">
        <small>${p.descripcion}</small>
        <small style="color:gray;">(${cat})</small>
      </label>
    `).join("");

    contenedor.innerHTML += `
      <details style="margin-bottom: 10px;">
        <summary style="font-weight:bold; cursor:pointer;">${cat.charAt(0).toUpperCase() + cat.slice(1)}</summary>
        <div style="display:flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
          ${productosHTML}
        </div>
      </details>
    `;
  });
}


  function cargarProductosEnSelector() {
  const selector = document.getElementById("productoRelacionado");
  selector.innerHTML = "";
  const categorias = ["caballero", "dama", "niños", "niñas", "accesorios"];
  categorias.forEach(cat => {
    const productos = JSON.parse(localStorage.getItem(cat)) || [];
    productos.forEach(p => {
      const opt = document.createElement("option");
      opt.value = JSON.stringify({ descripcion: p.descripcion, categoria: cat });
      opt.textContent = `${p.descripcion} (${cat})`;
      selector.appendChild(opt);
    });
  });
}

  function subirProducto() {
   const imagen = document.getElementById("urlImagenProducto").value;

    const descripcion = document.getElementById("descripcionProducto").value.trim();
    const precio = document.getElementById("precioProducto").value.trim();
    const categoria = document.getElementById("categoriaProducto").value;

    if (!imagen.startsWith("data:image") || !descripcion || !precio || !categoria) {
  alert("Faltan campos o imagen inválida");
  return;
} else {
  let productos = JSON.parse(localStorage.getItem(categoria)) || [];
  if (productos.length >= 200) {
    alert("Límite de 200 productos alcanzado en esta categoría.");
    return;
  }

  const nuevo = { imagen, descripcion, precio, categoria };
  productos.push(nuevo);
  localStorage.setItem(categoria, JSON.stringify(productos));

  let todos = JSON.parse(localStorage.getItem("productosTodos")) || [];
  todos.push(nuevo);
  localStorage.setItem("productosTodos", JSON.stringify(todos));

  mostrarAlerta("Producto guardado correctamente.");
mostrarProductos();
cargarProductosEnSelector();
crearCheckboxesProductos();



}

  }

  function mostrarProductos() {
    const cont = document.getElementById("listaProductos");
    cont.innerHTML = "";
    const categorias = ["caballero", "dama", "niños", "niñas", "accesorios"];
    tempProductos = {};

    categorias.forEach(cat => {
      const productos = JSON.parse(localStorage.getItem(cat)) || [];
      tempProductos[cat] = [...productos];

      productos.forEach((p, i) => {
        cont.innerHTML += `
          <div class="promo-item">
            <img src="${p.imagen}" class="editar-img" id="img-${cat}-${i}">
            <div class="input-file-wrapper">
  <span class="input-file-button">Cambiar imagen</span>
  <input type="file" onchange="actualizarImagenProducto('${cat}', ${i}, this)">
</div>

            <div class="promo-info">
              <strong>Categoría:</strong> ${cat}
              <input value="${p.descripcion}" onchange="editarProducto('${cat}', ${i}, 'descripcion', this.value)">
              <input type="number" value="${p.precio}" onchange="editarProducto('${cat}', ${i}, 'precio', this.value)">
              <button onclick="guardarProducto('${cat}', ${i})">Actualizar</button>
              <button onclick="eliminarProducto('${cat}', ${i})">Eliminar</button>
            </div>
          </div>`;
      });
    });
  }

  function editarProducto(cat, index, campo, valor) {
    if (!tempProductos[cat]) {
      tempProductos[cat] = JSON.parse(localStorage.getItem(cat)) || [];
    }
    tempProductos[cat][index][campo] = valor;
  }

  function actualizarImagenProducto(cat, index, input) {
    const reader = new FileReader();
    reader.onload = () => {
      document.getElementById(`img-${cat}-${index}`).src = reader.result;
      editarProducto(cat, index, "imagen", reader.result);
    };
    reader.readAsDataURL(input.files[0]);
  }

  function guardarProducto(cat, index) {
    localStorage.setItem(cat, JSON.stringify(tempProductos[cat]));
    mostrarAlerta("Producto actualizado.");
mostrarProductos();


  }

  function eliminarProducto(cat, index) {
    const productos = JSON.parse(localStorage.getItem(cat)) || [];
    productos.splice(index, 1);
    localStorage.setItem(cat, JSON.stringify(productos));

    let todos = JSON.parse(localStorage.getItem("productosTodos")) || [];
    todos = todos.filter(p => p.categoria !== cat || p.descripcion !== tempProductos[cat][index].descripcion);
    localStorage.setItem("productosTodos", JSON.stringify(todos));

 mostrarAlerta("Producto eliminado.");
mostrarProductos();
cargarProductosEnSelector();

    

  }

  function subirPromocion() {
  const imagen = document.getElementById("urlImagenPromocion").value;

  const descripcion = document.getElementById("descripcionPromocion").value.trim();
  const vencimiento = document.getElementById("vencimientoPromocion").value;

  const categorias = Array.from(document.querySelectorAll("input[name='categoriaPromo']:checked")).map(c => c.value);
  const productos = Array.from(document.querySelectorAll("input[name='productoPromo']:checked")).map(p => JSON.parse(p.value));

  if (!imagen.startsWith("data:image") || !descripcion || !vencimiento) {
    alert("Faltan campos o imagen inválida");
    return;
  }

  const promociones = JSON.parse(localStorage.getItem("promociones")) || [];
  promociones.push({ imagen, descripcion, categorias, productos, vencimiento });
  localStorage.setItem("promociones", JSON.stringify(promociones));

  mostrarPromociones();
  mostrarAlerta("Promoción guardada correctamente.");

}



  function mostrarPromociones() {
  const cont = document.getElementById("listaPromociones");
  cont.innerHTML = "";
  const promociones = JSON.parse(localStorage.getItem("promociones")) || [];
  tempPromos = [...promociones];

  promociones.forEach((p, i) => {
    const idAcordeon = `acordeon-${i}`;
    let acordeonesHTML = "";
    const categorias = ["caballero", "dama", "niños", "niñas", "accesorios"];

    categorias.forEach(cat => {
      const productos = JSON.parse(localStorage.getItem(cat)) || [];
      if (productos.length === 0) return;

      const productosHTML = productos.map((prod, j) => {
        const isChecked = p.productos?.some(pp => pp.descripcion === prod.descripcion && pp.categoria === cat);
        return `
          <label style="display:flex;flex-direction:column;align-items:center;width:100px;">
            <input type="checkbox" onchange="toggleProductoPromo(${i}, '${cat}', '${prod.descripcion}', this.checked)" ${isChecked ? "checked" : ""}>
            <img src="${prod.imagen}" style="width:60px;height:60px;object-fit:cover;border-radius:6px;">
            <small>${prod.descripcion}</small>
            <small style="color:gray;">(${cat})</small>
          </label>
        `;
      }).join("");

      acordeonesHTML += `
        <details>
          <summary><strong>${cat.charAt(0).toUpperCase() + cat.slice(1)}</strong></summary>
          <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;">${productosHTML}</div>
        </details>
      `;
    });

    cont.innerHTML += `
      <div class="promo-item">
        <img src="${p.imagen}" class="editar-img" id="promo-img-${i}">
        <div class="input-file-wrapper">
  <span class="input-file-button">Cambiar imagen</span>
  <input type="file" onchange="actualizarImagenPromo(${i}, this)">
</div>

        <div class="promo-info">
          <textarea onchange="editarPromo(${i}, 'descripcion', this.value)">${p.descripcion}</textarea>
          <input type="date" value="${p.vencimiento || ''}" onchange="editarPromo(${i}, 'vencimiento', this.value)">
          <div><strong>Categorías:</strong></div>
<div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">
  ${["caballero", "dama", "niños", "niñas", "accesorios"].map(cat => `
    <label>
      <input type="checkbox" onchange="toggleCategoriaPromo(${i}, '${cat}', this.checked)" 
        ${p.categorias?.includes(cat) ? "checked" : ""}>
      ${cat.charAt(0).toUpperCase() + cat.slice(1)}
    </label>
  `).join("")}
</div>

          <div><strong>Editar productos relacionados:</strong></div>
          ${acordeonesHTML}
          <button onclick="guardarPromo(${i})">Actualizar</button>
          <button onclick="eliminarPromo(${i})">Eliminar</button>
        </div>
      </div>`;
  });
}


function generarEdicionCategoriasPromocion(seleccionadas, promoIndex) {
  const categorias = ["caballero", "dama", "niños", "niñas", "accesorios"];
  return categorias.map(cat => `
    <label style="margin-right: 10px;">
      <input type="checkbox" onchange="actualizarCategoriasPromo(${promoIndex})"
        ${seleccionadas.includes(cat) ? "checked" : ""} value="${cat}"> ${cat}
    </label>
  `).join("");
}

function generarEdicionProductosPromocion(seleccionados, promoIndex) {
  const categorias = ["caballero", "dama", "niños", "niñas", "accesorios"];
  const seleccionadosStr = seleccionados.map(p => JSON.stringify(p));
  let html = "";

  categorias.forEach(cat => {
    const productos = JSON.parse(localStorage.getItem(cat)) || [];
    productos.forEach(prod => {
      const value = JSON.stringify({ descripcion: prod.descripcion, categoria: cat });
      const checked = seleccionadosStr.includes(value);
      html += `
        <label style="display:inline-block; text-align:center; margin:5px;">
          <input type="checkbox" value='${value}' onchange="actualizarProductosPromo(${promoIndex})"
            ${checked ? "checked" : ""}>
          <img src="${prod.imagen}" style="width:50px;height:50px;object-fit:cover;border-radius:5px;"><br>
          <small>${prod.descripcion}</small><br>
          <small style="color:gray;">(${cat})</small>
        </label>
      `;
    });
  });

  return html || "<p style='color:gray;'>No hay productos disponibles</p>";
}

// Actualiza categorías seleccionadas desde los checkboxes
function actualizarCategoriasPromo(index) {
  const checkboxes = document.querySelectorAll(`.promo-info:nth-child(${index + 1}) input[type="checkbox"][value]`);
  const seleccionadas = Array.from(checkboxes)
    .filter(cb => cb.checked && cb.value && !cb.value.includes("{"))
    .map(cb => cb.value);
  tempPromos[index].categorias = seleccionadas;
}

// Actualiza productos seleccionados desde los checkboxes
function actualizarProductosPromo(index) {
  const checkboxes = document.querySelectorAll(`.promo-info:nth-child(${index + 1}) input[type="checkbox"][value]`);
  const seleccionados = Array.from(checkboxes)
    .filter(cb => cb.checked && cb.value.includes("{"))
    .map(cb => JSON.parse(cb.value));
  tempPromos[index].productos = seleccionados;
}


// Función auxiliar para recuperar la imagen del producto según su categoría y descripción
function obtenerImagenProducto(descripcion, categoria) {
  const productos = JSON.parse(localStorage.getItem(categoria)) || [];
  const prod = productos.find(p => p.descripcion === descripcion);
  return prod ? prod.imagen : "https://via.placeholder.com/50x50?text=Sin+img";
}


  function editarPromo(index, campo, valor) {
    tempPromos[index][campo] = valor;
  }
  function toggleCategoriaPromo(index, categoria, checked) {
  if (!tempPromos[index].categorias) tempPromos[index].categorias = [];
  const idx = tempPromos[index].categorias.indexOf(categoria);
  if (checked && idx === -1) {
    tempPromos[index].categorias.push(categoria);
  } else if (!checked && idx !== -1) {
    tempPromos[index].categorias.splice(idx, 1);
  }
}

function toggleProductoPromo(index, categoria, descripcion, checked) {
  if (!tempPromos[index].productos) tempPromos[index].productos = [];
  const existe = tempPromos[index].productos.find(p => p.descripcion === descripcion && p.categoria === categoria);

  if (checked && !existe) {
    tempPromos[index].productos.push({ descripcion, categoria });
  } else if (!checked && existe) {
    tempPromos[index].productos = tempPromos[index].productos.filter(p => !(p.descripcion === descripcion && p.categoria === categoria));
  }
}


  function actualizarImagenPromo(index, input) {
    const reader = new FileReader();
    reader.onload = () => {
      document.getElementById(`promo-img-${index}`).src = reader.result;
      editarPromo(index, "imagen", reader.result);
    };
    reader.readAsDataURL(input.files[0]);
  }

  function guardarPromo(index) {
    localStorage.setItem("promociones", JSON.stringify(tempPromos));
    mostrarPromociones();
    mostrarAlerta("Promoción actualizada.");

  }

  function eliminarPromo(index) {
    const promociones = JSON.parse(localStorage.getItem("promociones")) || [];
    promociones.splice(index, 1);
    localStorage.setItem("promociones", JSON.stringify(promociones));
    mostrarPromociones();
    mostrarAlerta("Promoción eliminada.");

  }

  window.onload = () => {
  mostrarProductos();
  mostrarPromociones();
  crearCheckboxesCategorias();
  crearCheckboxesProductos();
  bloquearFechasPasadas(); 
};

function mostrarAlerta(mensaje) {
  const alerta = document.getElementById("alerta");
  alerta.textContent = mensaje;
  alerta.style.display = "block";
  setTimeout(() => {
    alerta.style.display = "none";
  }, 3000);
}


function limpiarFormularioProducto() {
  document.getElementById("fileProducto").value = "";
  document.getElementById("previewProducto").src = "";
  document.getElementById("descripcionProducto").value = "";
  document.getElementById("precioProducto").value = "";
  document.getElementById("categoriaProducto").selectedIndex = 0;
}

function limpiarFormularioPromocion() {
  document.getElementById("filePromocion").value = "";
  document.getElementById("previewPromocion").src = "";
  document.getElementById("descripcionPromocion").value = "";
  document.getElementById("vencimientoPromocion").value = "";

  document.querySelectorAll("input[name='categoriaPromo']").forEach(cb => cb.checked = false);
  document.querySelectorAll("input[name='productoPromo']").forEach(cb => cb.checked = false);
}
// Bloquear fechas pasadas en el input de vencimiento
function bloquearFechasPasadas() {
  const hoy = new Date().toISOString().split("T")[0]; // yyyy-mm-dd
  document.getElementById("vencimientoPromocion").setAttribute("min", hoy);
}
function subirACloudinaryProducto(input) {
  const file = input.files[0];
  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", "opticaAAXIS");
  
  fetch("https://api.cloudinary.com/v1_1/@dm70ald1m/image/upload", {
    method: "POST",
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    document.getElementById("urlImagenProducto").value = data.secure_url;
    document.getElementById("previewProducto").src = data.secure_url;
    document.getElementById("previewProducto").style.display = "block";
  });
}

function subirACloudinaryPromocion(input) {
  const file = input.files[0];
  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", "opticaAAXIS");

  fetch("https://api.cloudinary.com/v1_1/@dm70ald1m/image/upload", {
    method: "POST",
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    document.getElementById("urlImagenPromocion").value = data.secure_url;
    document.getElementById("previewPromocion").src = data.secure_url;
    document.getElementById("previewPromocion").style.display = "block";
  });
}

</script>
</body>
</html>
