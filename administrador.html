<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel de Administración - Óptica ITP</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: sans-serif; background: #f4f4f4; margin: 0; }
    .admin-container { max-width: 960px; margin: auto; padding: 20px; }
    .formulario, .promo-list {
      background: #fff; margin-top: 20px; padding: 20px;
      border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .preview-image, .editar-img {
      width: 100px; height: 100px; object-fit: cover; border-radius: 8px;
    }
    .promo-item { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
    .promo-info { flex: 1; }
    .promo-info input, .promo-info select, .promo-info textarea {
      width: 100%; margin: 5px 0; padding: 6px;
    }
    button {
      margin: 4px 4px 0 0; padding: 6px 12px; background: #87CEEB;
      color: white; border: none; border-radius: 5px; cursor: pointer;
    }
    button:hover { background: #4682B4; }
    .alerta {
      background-color: #d4edda; color: #155724;
      border: 1px solid #c3e6cb; padding: 10px 20px;
      border-radius: 5px; margin: 10px auto; font-weight: bold;
      display: none; text-align: center;
      width: fit-content; max-width: 90%;
      animation: fadeInOut 3s ease-in-out;
      position: fixed; top: 20px; left: 50%;
      transform: translateX(-50%); box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 9999;
    }
    @keyframes fadeInOut {
      0% { opacity: 0; } 10% { opacity: 1; }
      90% { opacity: 1; } 100% { opacity: 0; }
    }
     .checkbox-categorias {
      display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0;
    }
    .checkbox-categorias label {
      display: flex; align-items: center; gap: 5px;
      background: #eee; padding: 5px 10px; border-radius: 5px;
    }
    #productosCheckboxes details {
      margin-bottom: 10px;
    }
    #productosCheckboxes label {
      display: flex; align-items: center; gap: 10px;
      padding: 4px; border-radius: 5px;
    }
    #productosCheckboxes img {
      width: 40px; height: 40px; object-fit: cover; border-radius: 4px;
    }
.producto-relacionado {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 140px;
  margin: 10px;
  text-align: center;
}
.producto-relacionado img {
  width: 100px;
  height: 100px;
  object-fit: cover;
  border-radius: 8px;
}
.producto-relacionado .descripcion {
  margin: 5px 0;
  font-size: 14px;
}
.producto-relacionado input[type="checkbox"] {
  margin-top: 5px;
}



  </style>
</head>
<body>

  <header>
    <h1>Panel de Administración</h1>
    <nav><a href="index.html">Regresar a Página Principal</a></nav>
  </header>

  <main>
    <section class="admin-container">
      <h2>Gestión de Contenido</h2>
      <div class="formulario promo-list">
      
      <!-- Formulario Productos -->
      <div class="formulario">
        <h3>Subir Producto</h3>
        <input type="file" id="fileProducto" accept="image/*" onchange="subirACloudinaryProducto(this)">
        <img id="previewProducto" class="preview-image" style="display:none;">
        <input type="hidden" id="urlImagenProducto">
        <input type="text" id="descripcionProducto" placeholder="Descripción">
        <input type="number" id="precioProducto" placeholder="Precio">
        <select id="categoriaProducto">
          <option value="caballero">Caballero</option>
          <option value="dama">Dama</option>
          <option value="niños">Niños</option>
          <option value="niñas">Niñas</option>
          <option value="accesorios">Accesorios</option>
        </select>
        <button onclick="subirProducto()">Guardar Producto</button>
        <button onclick="limpiarFormularioProducto()">Limpiar</button>
      </div>

      <!-- Formulario Promociones -->
      <div class="formulario">
      <h3>Subir Promoción</h3>
      <input type="file" id="filePromocion" accept="image/*" onchange="subirACloudinaryPromocion(this)">
      <img id="previewPromocion" class="preview-image" style="display:none;">
      <input type="hidden" id="urlImagenPromocion">
      <textarea id="descripcionPromocion" placeholder="Descripción de la promoción"></textarea>
      <label><strong>Categorías:(opcional)</strong></label>
      <div class="checkbox-categorias">
        <label><input type="checkbox" name="categoriaPromo" value="caballero"> Caballero</label>
        <label><input type="checkbox" name="categoriaPromo" value="dama"> Dama</label>
        <label><input type="checkbox" name="categoriaPromo" value="niños"> Niños</label>
        <label><input type="checkbox" name="categoriaPromo" value="niñas"> Niñas</label>
        <label><input type="checkbox" name="categoriaPromo" value="accesorios"> Accesorios</label>
      </div>
      <label>Fecha de vencimiento</label>
      <input type="date" id="vencimientoPromocion" min="">
      <div id="productosCheckboxes" style="margin-top: 10px;"></div>
      <button onclick="subirPromocion()">Guardar Promoción</button>
      <button onclick="limpiarFormularioPromocion()">Limpiar</button>
    </div>

      <!-- Listas -->
      <div class="formulario promo-list">
        <h3>Productos registrados</h3>
        <div id="listaProductos"></div>
      </div>

      <div class="formulario promo-list">
        <h3>Promociones registradas</h3>
        <div id="listaPromociones"></div>
      </div>

    </section>
  </main>

  <div id="alerta" class="alerta"></div>

  <!-- Firebase -->
 <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB11z4COh5adtBgNqar2Gx4JtLfIMB-KIg",
      authDomain: "optica-aaxis.firebaseapp.com",
      databaseURL: "https://optica-aaxis-default-rtdb.firebaseio.com",
      projectId: "optica-aaxis",
      storageBucket: "optica-aaxis.appspot.com",
      messagingSenderId: "796057879313",
      appId: "1:796057879313:web:872dc9b3ce45f0172b82b0"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>

  <script>
    async function subirImagenCloudinary(file) {
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", "archivoproductos123");
      const res = await fetch("https://api.cloudinary.com/v1_1/aaxisopt/image/upload", {
        method: "POST",
        body: formData
      });
      const data = await res.json();
      return data.secure_url;
    }

    async function subirACloudinaryProducto(input) {
      const url = await subirImagenCloudinary(input.files[0]);
      if (url) {
        document.getElementById("previewProducto").src = url;
        document.getElementById("previewProducto").style.display = "block";
        document.getElementById("urlImagenProducto").value = url;
      }
    }

    async function subirACloudinaryPromocion(input) {
      const url = await subirImagenCloudinary(input.files[0]);
      if (url) {
        document.getElementById("previewPromocion").src = url;
        document.getElementById("previewPromocion").style.display = "block";
        document.getElementById("urlImagenPromocion").value = url;
      }
    }

    async function subirProducto() {
      const descripcion = document.getElementById("descripcionProducto").value.trim();
      const precio = document.getElementById("precioProducto").value.trim();
      const categoria = document.getElementById("categoriaProducto").value;
      const imagenURL = document.getElementById("urlImagenProducto").value;
      if (!descripcion || !precio || !imagenURL) return alert("Completa todos los campos");

      const producto = { descripcion, precio: Number(precio), categoria, imagen: imagenURL };
      await db.ref(`productos/${categoria}`).push(producto);
      mostrarAlerta("Producto guardado");
      limpiarFormularioProducto();
      mostrarProductos();
    }

    async function subirPromocion() {
      const descripcion = document.getElementById("descripcionPromocion").value.trim();
      const vencimiento = document.getElementById("vencimientoPromocion").value;
      const imagen = document.getElementById("urlImagenPromocion").value;
      const categorias = Array.from(document.querySelectorAll("input[name='categoriaPromo']:checked")).map(c => c.value);
      if (!descripcion || !vencimiento || !imagen) return alert("Faltan campos");
      const productos = Array.from(document.querySelectorAll("input[name='productoRelacionado']:checked"))
  .map(cb => ({
    id: cb.value,
    descripcion: cb.getAttribute("data-descripcion"),
    categoria: cb.getAttribute("data-categoria")
  }));

      const promo = { descripcion, vencimiento, imagen, categorias, productos };
      await db.ref("promociones").push(promo);
      mostrarAlerta("Promoción guardada");
      limpiarFormularioPromocion();
      mostrarPromociones();
    }

    function mostrarProductos() {
  const cont = document.getElementById("listaProductos");
  cont.innerHTML = "";
  const categorias = ["caballero", "dama", "niños", "niñas", "accesorios"];

  categorias.forEach(cat => {
    const details = document.createElement("details");
    const summary = document.createElement("summary");
    summary.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
    details.appendChild(summary);

    db.ref(`productos/${cat}`).once("value").then(snap => {
      const productos = snap.val();
      if (productos) {
        Object.entries(productos).forEach(([id, p]) => {
          const div = document.createElement("div");
          div.className = "promo-item";
          div.innerHTML = `
            <div style="text-align: center;">
              <img src="${p.imagen}" class="editar-img"><br>
              <button onclick="actualizarImagen('producto', '${cat}', '${id}')">Cambiar Imagen</button>
            </div>
            <div class="promo-info">
              <input value="${p.descripcion}" onchange="actualizarCampoProducto('${cat}', '${id}', 'descripcion', this.value)">
              <input value="${p.precio}" onchange="actualizarCampoProducto('${cat}', '${id}', 'precio', this.value)">
              <select onchange="actualizarCampoProducto('${cat}', '${id}', 'categoria', this.value)">
                ${categorias.map(c => `
                  <option value="${c}" ${p.categoria === c ? "selected" : ""}>${c.charAt(0).toUpperCase() + c.slice(1)}</option>
                `).join("")}
              </select>
              <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="actualizarTodoProducto('${cat}', '${id}')">Actualizar Todo</button>
                <button onclick="eliminarProducto('${cat}', '${id}')">Eliminar</button>
              </div>
            </div>
          `;
          details.appendChild(div);
        });
      } else {
        const mensaje = document.createElement("p");
        mensaje.textContent = "No hay productos registrados en esta categoría.";
        details.appendChild(mensaje);
      }
    });

    cont.appendChild(details);
  });
}


function actualizarTodoProducto(cat, id) {
  const descripcion = document.getElementById(`descripcion-${id}`).value;
  const precio = document.getElementById(`precio-${id}`).value;
  const nuevaCategoria = document.getElementById(`categoria-${id}`).value;

  const productoActualizado = {
    descripcion,
    precio: Number(precio),
    categoria: nuevaCategoria
  };

  if (nuevaCategoria !== cat) {
    db.ref(`productos/${cat}/${id}`).once("value").then(snapshot => {
      const producto = snapshot.val();
      db.ref(`productos/${cat}/${id}`).remove();
      db.ref(`productos/${nuevaCategoria}`).push({ ...producto, ...productoActualizado });
      mostrarAlerta("Categoría cambiada y producto actualizado");
      mostrarProductos();
    });
  } else {
    db.ref(`productos/${cat}/${id}`).update(productoActualizado).then(() => {
      mostrarAlerta("Producto actualizado");
    });
  }
}


    function mostrarPromociones() {
      const cont = document.getElementById("listaPromociones");
      cont.innerHTML = "";
      db.ref("promociones").once("value").then(snap => {
        const promos = snap.val();
        if (promos) {
          Object.entries(promos).forEach(([id, promo]) => {
            const div = document.createElement("div");
            div.className = "promo-item";
            div.setAttribute("data-promocion-id", id);

           div.innerHTML = `
  <div style="text-align: center;">
    <img src="${promo.imagen}" class="editar-img"><br>
    <button onclick="actualizarImagen('promocion', null, '${id}')">Cambiar Imagen</button>
  </div>
  <div class="promo-info">
    <textarea onchange="actualizarCampoPromocion('${id}', 'descripcion', this.value)">${promo.descripcion}</textarea>
    <input type="date" value="${promo.vencimiento}" min="${new Date().toISOString().split('T')[0]}" onchange="actualizarCampoPromocion('${id}', 'vencimiento', this.value)">
    
    <div><strong>Categorías:</strong><br>
  <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px;">
    ${["caballero", "dama", "niños", "niñas", "accesorios"].map(cat => {
      const checked = promo.categorias?.includes(cat) ? "checked" : "";
      return `<label style="display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" name="cat_${id}" value="${cat}" ${checked}> ${cat.charAt(0).toUpperCase() + cat.slice(1)}
              </label>`;
    }).join("")}
  


    <div><strong>Productos relacionados:</strong> ${promo.productos?.map(p => `<div>${p.descripcion} (${p.categoria})</div>`).join("") || "Ninguno"}</div>
    <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
  <button onclick="abrirEdicionProductos('${id}')">Editar productos relacionados</button>
  <button onclick="actualizarTodoPromocion('${id}')">Actualizar Todo</button>
  <button onclick="eliminarPromocion('${id}')">Eliminar</button>
</div>

`;


            cont.appendChild(div);
          });
        }
      });
    }
    async function eliminarPromocionesVencidas() {
  const hoy = new Date().toISOString().split("T")[0];
  const snapshot = await db.ref("promociones").once("value");
  const promociones = snapshot.val();
  if (!promociones) return;

  Object.entries(promociones).forEach(([id, promo]) => {
    if (promo.vencimiento && promo.vencimiento < hoy) {
      db.ref(`promociones/${id}`).remove();
    }
  });
}

    function actualizarTodoPromocion(id) {
  const container = document.querySelector(`[data-promocion-id="${id}"]`);
  const descripcion = container.querySelector("textarea").value;
  const vencimiento = container.querySelector('input[type="date"]').value;

  const categorias = Array.from(container.querySelectorAll(`input[name="cat_${id}"]:checked`)).map(cb => cb.value);

  const productos = Array.from(container.querySelectorAll("input[name='productoEditar']:checked")).map(cb => ({
    id: cb.value,
    descripcion: cb.getAttribute("data-descripcion"),
    categoria: cb.getAttribute("data-categoria"),
    imagen: cb.getAttribute("data-imagen") || ""
  }));

  db.ref(`promociones/${id}`).update({
    descripcion,
    vencimiento,
    categorias,
    productos
  }).then(() => {
    mostrarAlerta("Promoción actualizada correctamente");
    mostrarPromociones();
  });
}

function generarCheckboxProductos() {
  const contenedor = document.getElementById("productosCheckboxes");
  contenedor.innerHTML = "";
  const categorias = ["caballero", "dama", "niños", "niñas", "accesorios"];

  categorias.forEach(cat => {
    const details = document.createElement("details");
    details.innerHTML = `<summary>${cat.toUpperCase()}</summary>`;
    const categoriaContenedor = document.createElement("div");
    categoriaContenedor.style.display = "flex";
    categoriaContenedor.style.flexWrap = "wrap";
    categoriaContenedor.style.gap = "10px";

    db.ref(`productos/${cat}`).once("value").then(snapshot => {
      const productos = snapshot.val();
      if (productos) {
        Object.entries(productos).forEach(([id, prod]) => {
          const div = document.createElement("div");
          div.className = "producto-relacionado";
          div.innerHTML = `
  <img src="${prod.imagen}" alt="${prod.descripcion}">
  <div class="descripcion">${prod.descripcion}</div>
  <input type="checkbox" name="productoRelacionado" value="${id}" data-categoria="${cat}" data-descripcion="${prod.descripcion}">
`;

          categoriaContenedor.appendChild(div);
        });
      }
    });

    details.appendChild(categoriaContenedor);
    contenedor.appendChild(details);
  });
}

function eliminarProducto(cat, id, imagenUrl) {
  db.ref(`productos/${cat}/${id}`).remove().then(() => {
    eliminarDeCloudinary(imagenUrl);
    mostrarAlerta("Producto eliminado");
    mostrarProductos();
  });
}

    function actualizarCampoProducto(cat, id, campo, valor) {
  db.ref(`productos/${cat}/${id}/${campo}`).set(valor).then(() => {
    mostrarAlerta("Producto actualizado");
  });
}


    function actualizarCampoPromocion(id, campo, valor) {
      db.ref(`promociones/${id}/${campo}`).set(valor);
      mostrarAlerta("Promoción actualizada");
    }

    function eliminarProducto(cat, id) {
      db.ref(`productos/${cat}/${id}`).remove().then(mostrarProductos);
      mostrarAlerta("Producto eliminado");
    }

    function eliminarPromocion(id) {
      db.ref(`promociones/${id}`).remove().then(mostrarPromociones);
      mostrarAlerta("Promoción eliminada");
    }

    function mostrarAlerta(msg) {
      const alerta = document.getElementById("alerta");
      alerta.textContent = msg;
      alerta.style.display = "block";
      setTimeout(() => alerta.style.display = "none", 3000);
    }

    function limpiarFormularioProducto() {
      document.getElementById("fileProducto").value = "";
      document.getElementById("descripcionProducto").value = "";
      document.getElementById("precioProducto").value = "";
      document.getElementById("categoriaProducto").selectedIndex = 0;
      document.getElementById("urlImagenProducto").value = "";
      document.getElementById("previewProducto").style.display = "none";
    }
    
function abrirEdicionProductos(idPromo) {
  const contenedor = document.createElement("div");
  contenedor.innerHTML = `<h4>Selecciona productos relacionados:</h4>`;
  const categorias = ["caballero", "dama", "niños", "niñas", "accesorios"];

  db.ref(`promociones/${idPromo}`).once("value").then(promoSnap => {
    const promoActual = promoSnap.val();
    const productosSeleccionados = promoActual.productos?.map(p => p.id) || [];

    categorias.forEach(cat => {
      const details = document.createElement("details");
      details.innerHTML = `<summary>${cat.toUpperCase()}</summary>`;
      details.style.marginBottom = "10px";

      db.ref(`productos/${cat}`).once("value").then(snapshot => {
        const productos = snapshot.val();
        if (productos) {
          Object.entries(productos).forEach(([id, p]) => {
            const div = document.createElement("div");
            div.className = "producto-relacionado";
            const checked = productosSeleccionados.includes(id) ? "checked" : "";
            div.innerHTML = `
              <img src="${p.imagen}" alt="${p.descripcion}">
              <div>${p.descripcion}</div>
              <input type="checkbox" name="productoEditar" value="${id}" data-categoria="${cat}" data-descripcion="${p.descripcion}" ${checked}>
            `;
            details.appendChild(div);
          });
        }
      });

      contenedor.appendChild(details);
    });

    const guardarBtn = document.createElement("button");
    guardarBtn.textContent = "Guardar productos relacionados";
    guardarBtn.onclick = () => {
      const seleccionados = Array.from(contenedor.querySelectorAll("input[name='productoEditar']:checked")).map(cb => ({
        id: cb.value,
        descripcion: cb.getAttribute("data-descripcion"),
        categoria: cb.getAttribute("data-categoria")
      }));
      db.ref(`promociones/${idPromo}/productos`).set(seleccionados).then(() => {
        mostrarPromociones();
        mostrarAlerta("Productos relacionados actualizados");
      });
    };

    contenedor.appendChild(guardarBtn);
    const modal = document.createElement("div");
    modal.style = "position:fixed;top:0;left:0;width:100%;height:100%;background:#000a;display:flex;justify-content:center;align-items:center;z-index:9999;";
    const box = document.createElement("div");
    box.style = "background:white;padding:20px;border-radius:10px;max-height:90%;overflow:auto;";
    const cerrar = document.createElement("button");
    cerrar.textContent = "Cerrar";
    cerrar.onclick = () => modal.remove();
    box.appendChild(cerrar);
    box.appendChild(contenedor);
    modal.appendChild(box);
    document.body.appendChild(modal);
  });
}


    function limpiarFormularioPromocion() {
      document.getElementById("filePromocion").value = "";
      document.getElementById("descripcionPromocion").value = "";
      document.getElementById("vencimientoPromocion").value = "";
      document.getElementById("urlImagenPromocion").value = "";
      document.getElementById("previewPromocion").style.display = "none";
      document.querySelectorAll("input[name='categoriaPromo']").forEach(cb => cb.checked = false);
    }
    function actualizarCategoriaPromocion(id) {
  const checkboxes = document.querySelectorAll(`input[name="cat_${id}"]:checked`);
  const categorias = Array.from(checkboxes).map(cb => cb.value);
  db.ref(`promociones/${id}/categorias`).set(categorias).then(() => {
    mostrarAlerta("Categorías actualizadas");
  });
}


function actualizarImagen(tipo, categoria, id) {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.onchange = async () => {
    const url = await subirImagenCloudinary(input.files[0]);
    const path = tipo === "producto" ? `productos/${categoria}/${id}/imagen` : `promociones/${id}/imagen`;
    db.ref(path).set(url).then(() => {
      mostrarAlerta("Imagen actualizada");
      if (tipo === "producto") mostrarProductos();
      else mostrarPromociones();
    });
  };
  input.click();
}

    window.onload = () => {
  eliminarPromocionesVencidas().then(() => {
    mostrarProductos();
    mostrarPromociones();
  });
  document.getElementById("vencimientoPromocion").min = new Date().toISOString().split("T")[0];
  generarCheckboxProductos();
};

  </script>
</body>
</html>

